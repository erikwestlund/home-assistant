- id: "hvac_radiator_changed_setpoint_main_zone"
  alias: "HVAC Radiator Changed Setpoint Main Zone"
  trigger:
    - platform: state
      entity_id: sensor.hvac_radiator_setpoint_main_zone
  condition:
    # Only sync if HA should control (away/override mode OR Ecobee schedule toggle is off)
    - condition: or
      conditions:
        - condition: state
          entity_id: input_boolean.hvac_away_mode
          state: "on"
        - condition: state
          entity_id: input_boolean.hvac_override_status_main_zone
          state: "on"
        - condition: state
          entity_id: input_boolean.hvac_radiator_use_ecobee_schedule_main_zone
          state: "off"
  action:
    - service: climate.set_temperature
      data:
        entity_id: climate.living_room_main_heating
        temperature: "{{ states('sensor.hvac_radiator_setpoint_main_zone') | float(0) }}"
    - service: logbook.log
      data:
        name: "HVAC Radiator Setpoint Changed Main Zone"
        message: >
          New setpoint applied: {{ states('sensor.hvac_radiator_setpoint_main_zone') }}°F.
  mode: single

- id: "hvac_sync_radiator_power_mode_setpoint_main_zone"
  alias: "HVAC Sync Radiator Power, Mode, and Setpoint Main Zone"
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.hvac_radiator_power_synced_main_zone
        - binary_sensor.hvac_radiator_mode_synced_main_zone
        - binary_sensor.hvac_radiator_setpoint_synced_main_zone
        - input_boolean.hvac_override_status_main_zone
        - input_boolean.hvac_away_mode
        - input_boolean.hvac_radiator_use_ecobee_schedule_main_zone
    - platform: time_pattern
      minutes: "/5"
  condition:
    # Only sync if HA should control (away/override mode OR Ecobee schedule toggle is off)
    - condition: or
      conditions:
        - condition: state
          entity_id: input_boolean.hvac_away_mode
          state: "on"
        - condition: state
          entity_id: input_boolean.hvac_override_status_main_zone
          state: "on"
        - condition: state
          entity_id: input_boolean.hvac_radiator_use_ecobee_schedule_main_zone
          state: "off"
  action:
    - choose:
        # ✅ Power, Mode, and Setpoint All at Once if Radiator is Off
        - conditions:
            - condition: state
              entity_id: binary_sensor.hvac_radiator_power_synced_main_zone
              state: "off"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.living_room_main_heating
                hvac_mode: >
                  {% if is_state('binary_sensor.hvac_radiator_power_status_main_zone', 'on') %}
                    heat
                  {% else %}
                    off
                  {% endif %}
            - service: climate.set_temperature
              data:
                entity_id: climate.living_room_main_heating
                temperature: >
                  {{ states('sensor.hvac_radiator_setpoint_main_zone') | float(0) }}
            - service: logbook.log
              data:
                name: "HVAC Sync Radiator Main Zone"
                message: >
                  Radiator turned on. Mode set to heat and temperature set to:
                  {{ states('sensor.hvac_radiator_setpoint_main_zone') }}°F.

        # ✅ Correct Mode and Setpoint if Mode is Incorrect
        - conditions:
            - condition: state
              entity_id: binary_sensor.hvac_radiator_mode_synced_main_zone
              state: "off"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.living_room_main_heating
                hvac_mode: heat
            - service: climate.set_temperature
              data:
                entity_id: climate.living_room_main_heating
                temperature: >
                  {{ states('sensor.hvac_radiator_setpoint_main_zone') | float(0) }}
            - service: logbook.log
              data:
                name: "HVAC Sync Radiator Main Zone"
                message: >
                  Mode corrected to heat and temperature set to:
                  {{ states('sensor.hvac_radiator_setpoint_main_zone') }}°F.

        # ✅ Correct Setpoint if Setpoint is Incorrect
        - conditions:
            - condition: state
              entity_id: binary_sensor.hvac_radiator_setpoint_synced_main_zone
              state: "off"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.living_room_main_heating
                temperature: >
                  {{ states('sensor.hvac_radiator_setpoint_main_zone') | float(0) }}
            - service: logbook.log
              data:
                name: "HVAC Sync Radiator Main Zone"
                message: >
                  Setpoint corrected to {{ states('sensor.hvac_radiator_setpoint_main_zone') }}°F.
  mode: single