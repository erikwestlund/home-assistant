- id: "set_ducted_unit_setpoint"
  alias: "Set Ducted Unit Setpoint"
  trigger:
    - platform: state
      entity_id: sensor.ducted_system_setpoint_target_temperature
    - platform: state
      entity_id: climate.ducted_heat_pump
      attribute: current_temperature
  condition:
    - condition: template
      value_template: >
        {{ states('sensor.ducted_system_setpoint_target_temperature') != 'None' }}
  action:
    - variables:
        target_temperature: "{{ states('sensor.ducted_system_setpoint_target_temperature') | float(0) }}"
        current_temperature: "{{ state_attr('climate.ducted_heat_pump', 'current_temperature') | float(0) }}"
        offset: "{{ states('input_number.ducted_setpoint_heat_stop_threshold_offset') | float(0) }}"
    - choose:
        # Turn off the ducted system if the current temperature exceeds target + offset
        - conditions:
            - condition: template
              value_template: >
                {{ current_temperature > (target_temperature + offset) }}
          sequence:
            - service: climate.turn_off
              target:
                entity_id: climate.ducted_heat_pump
            - service: logbook.log
              data:
                name: "Ducted Unit Automation"
                message: >
                  Ducted system turned off. Current temperature: {{ current_temperature }}째F
                  exceeded threshold of {{ target_temperature + offset }}째F.
        # Turn on the ducted system if it's off and within the allowable range
        - conditions:
            - condition: template
              value_template: >
                {{ is_state('climate.ducted_heat_pump', 'off') and current_temperature <= (target_temperature + offset) }}
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.ducted_heat_pump
                hvac_mode: "heat"
            - service: logbook.log
              data:
                name: "Ducted Unit Automation"
                message: >
                  Ducted system turned on. Current temperature: {{ current_temperature }}째F.
        # Update the temperature if the target temperature changes
        - conditions:
            - condition: template
              value_template: >
                {{ state_attr('climate.ducted_heat_pump', 'temperature') | float(0) != target_temperature }}
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.ducted_heat_pump
                temperature: "{{ target_temperature }}"
            - service: logbook.log
              data:
                name: "Ducted Unit Automation"
              message: >
                Updated ducted system target temperature to {{ target_temperature }}째F.
  mode: single