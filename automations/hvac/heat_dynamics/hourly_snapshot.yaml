- id: collect_hourly_energy_usage_snapshot_office
  alias: "Collect Hourly Energy Usage Snapshot for Office"
  trigger:
    platform: time_pattern
    minutes: '1'  # Store first minute so all the 0 trackers are updated
  action:
    - service: input_text.set_value
      target:
        entity_id: input_text.hvac_hourly_snapshot_office
      data:
        value: >
          {{
            {
              "timestamp": now().strftime('%Y-%m-%d %H:%M:%S'),
              "outdoor_temp_hour_ago": states('input_number.outdoor_temperature_60m_ago') | float(0),
              "outdoor_temp_current": states('sensor.current_temperature') | float(0),
              "outdoor_hour_temp_change": (states('sensor.current_temperature') | float(0)) - (states('input_number.outdoor_temperature_60m_ago') | float(0)),
              "temp_now": states('sensor.tina_office_average_temperature') | float(0),
              "hour_temp_change": (states('sensor.tina_office_average_temperature') | float(0)) - (states('input_number.hvac_office_average_temperature_60m_ago') | float(0)),
              "mini_split_setpoint_prev_hour": 'off' if (states('input_number.hvac_mini_split_setpoint_office_60m_ago') | float(0)) == 0 else states('input_number.hvac_mini_split_setpoint_office_60m_ago'),
              "mini_split_setpoint_change": 1 if (states('sensor.hvac_mini_split_setpoint_office') | float(0)) != (states('input_number.hvac_mini_split_setpoint_office_60m_ago') | float(0)) else 0,
              "radiator_setpoint_prev_hour": 'off' if (states('input_number.hvac_radiator_setpoint_office_60m_ago') | float(0)) == 0 else states('input_number.hvac_radiator_setpoint_office_60m_ago'),
              "radiator_setpoint_change": 1 if (states('sensor.hvac_radiator_setpoint_office') | float(0)) != (states('input_number.hvac_radiator_setpoint_office_60m_ago') | float(0)) else 0,
              "space_heater_power_status_prev_hour": 'off' if (states('binary_sensor.space_heater_power_status_office_60m_ago') == 'off') else 'on',
              "space_heater_power_status_change": 1 if (states('binary_sensor.hvac_space_heater_active_office') != states('input_boolean.space_heater_power_status_office_60m_ago')) else 0,
              "erik_office_temp_prev_hour": states('sensor.hvac_erik_office_temperature_60m_ago') | float(0),
              "kitchen_temp_prev_hour": states('sensor.hvac_kitchen_temperature_60m_ago') | float(0),
              "office_radiators_called_for_heat_within_hour": 1 if (states('input_boolean.radiator_called_for_heat_living_room_previous_hour') == 'on') else 0,
              "erik_office_mini_split_setpoint_prev_hour": 'off' if (states('input_number.hvac_mini_split_setpoint_erik_office_60m_ago') | float(0) == 0) else states('input_number.hvac_mini_split_setpoint_erik_office_60m_ago'),
              "erik_office_mini_split_setpoint_change": 1 if (states('sensor.hvac_mini_split_setpoint_erik_office') | float(0) != (states('input_number.hvac_mini_split_setpoint_erik_office_60m_ago') | float(0))) else 0,
              "dining_room_mini_split_setpoint_prev_hour": 'off' if (states('input_number.hvac_mini_split_setpoint_dining_room_60m_ago') | float(0) == 0) else states('input_number.hvac_mini_split_setpoint_dining_room_60m_ago'),
              "dining_room_mini_split_setpoint_change": 1 if (states('sensor.hvac_mini_split_setpoint_dining_room') | float(0) != (states('input_number.hvac_mini_split_setpoint_dining_room_60m_ago') | float(0))) else 0,
              "offices_dining_room_kwh_hourly": states('input_number.heat_pump_offices_dining_room_energy_hourly') | float(0)
            } | tojson
          }}

- id: collect_hourly_energy_usage_snapshot_family_room
  alias: "Collect Hourly Energy Usage Snapshot for Family Room"
  trigger:
    platform: time_pattern
    minutes: '0'  # Trigger at the start of the hour
  action:
    - service: input_text.set_value
      target:
        entity_id: input_text.hvac_hourly_snapshot_office
      data:
        value: >
          {{
            {
              "timestamp": now().strftime('%Y-%m-%d %H:%M:%S'),
              "outdoor_temp_hour_ago": states('input_number.outdoor_temperature_60m_ago') | float(0),
              "outdoor_temp_current": states('sensor.current_temperature') | float(0),
              "outdoor_hour_temp_change": (states('sensor.current_temperature') | float(0)) - (states('input_number.outdoor_temperature_60m_ago') | float(0)),
              "temp_now": states('sensor.tina_office_average_temperature') | float(0),
              "hour_temp_change": (states('sensor.tina_office_average_temperature') | float(0)) - (states('input_number.hvac_office_average_temperature_60m_ago') | float(0)),
              "mini_split_setpoint_prev_hour": 'off' if (states('input_number.hvac_mini_split_setpoint_office_60m_ago') | float(0)) == 0 else states('input_number.hvac_mini_split_setpoint_office_60m_ago'),
              "mini_split_setpoint_change": 1 if (states('sensor.hvac_mini_split_setpoint_office') | float(0)) != (states('input_number.hvac_mini_split_setpoint_office_60m_ago') | float(0)) else 0,
              "radiator_setpoint_prev_hour": 'off' if (states('input_number.hvac_radiator_setpoint_office_60m_ago') | float(0)) == 0 else states('input_number.hvac_radiator_setpoint_office_60m_ago'),
              "radiator_setpoint_change": 1 if (states('sensor.hvac_radiator_setpoint_office') | float(0)) != (states('input_number.hvac_radiator_setpoint_office_60m_ago') | float(0)) else 0,
              "space_heater_power_status_prev_hour": 'off' if (states('binary_sensor.space_heater_power_status_office_60m_ago') == 'off') else 'on',
              "space_heater_power_status_change": 1 if (states('binary_sensor.hvac_space_heater_active_office') != states('input_boolean.space_heater_power_status_office_60m_ago')) else 0,
              "erik_office_temp_prev_hour": states('sensor.hvac_erik_office_temperature_60m_ago') | float(0),
              "kitchen_temp_prev_hour": states('sensor.hvac_kitchen_temperature_60m_ago') | float(0),
              "office_radiators_called_for_heat_within_hour": 1 if (states('input_boolean.radiator_called_for_heat_living_room_previous_hour') == 'on') else 0,
              "erik_office_mini_split_setpoint_prev_hour": 'off' if (states('input_number.hvac_mini_split_setpoint_erik_office_60m_ago') | float(0) == 0) else states('input_number.hvac_mini_split_setpoint_erik_office_60m_ago'),
              "erik_office_mini_split_setpoint_change": 1 if (states('sensor.hvac_mini_split_setpoint_erik_office') | float(0) != (states('input_number.hvac_mini_split_setpoint_erik_office_60m_ago') | float(0))) else 0,
              "dining_room_mini_split_setpoint_prev_hour": 'off' if (states('input_number.hvac_mini_split_setpoint_dining_room_60m_ago') | float(0) == 0) else states('input_number.hvac_mini_split_setpoint_dining_room_60m_ago'),
              "dining_room_mini_split_setpoint_change": 1 if (states('sensor.hvac_mini_split_setpoint_dining_room') | float(0) != (states('input_number.hvac_mini_split_setpoint_dining_room_60m_ago') | float(0))) else 0,
              "offices_dining_room_kwh_hourly": states('input_number.heat_pump_offices_dining_room_energy_hourly') | float(0)
            } | tojson
          }}

- id: collect_hourly_energy_usage_snapshot_family_room
  alias: "Collect Hourly Energy Usage Snapshot for Family Room"
  trigger:
    platform: time_pattern
    minutes: '1'  # Trigger at the start of the hour
  action:
    - service: input_text.set_value
      target:
        entity_id: input_text.hvac_hourly_snapshot_family_room
      data:
        value: >
          {{
            {
              "timestamp": now().strftime('%Y-%m-%d %H:%M:%S'),
              "outdoor_temp_hour_ago": states('input_number.outdoor_temperature_60m_ago') | float(0),
              "outdoor_temp_current": states('sensor.current_temperature') | float(0),
              "outdoor_hour_temp_change": (states('sensor.current_temperature') | float(0)) - (states('input_number.outdoor_temperature_60m_ago') | float(0)),
              "temp_now": states('sensor.family_room_average_temperature') | float(0),
              "hour_temp_change": (states('sensor.family_room_average_temperature') | float(0)) - (states('input_number.hvac_family_room_average_temperature_60m_ago') | float(0)),
              "mini_split_setpoint_prev_hour": 
                'off' if (states('input_boolean.mini_split_power_status_family_room_60m_ago') == 'off') 
                else (
                  'off' if (states('input_number.hvac_mini_split_setpoint_family_room_60m_ago') | float(0)) <= 0 
                  else states('input_number.hvac_mini_split_setpoint_family_room_60m_ago')
                ),
              "mini_split_setpoint_change": 
                1 if (states('sensor.hvac_mini_split_setpoint_family_room') | float(0)) != (states('input_number.hvac_mini_split_setpoint_family_room_60m_ago') | float(0)) 
                or (states('input_boolean.mini_split_power_status_family_room_60m_ago') != states('input_boolean.mini_split_power_status_family_room')) 
                else 0,
              "radiator_setpoint_prev_hour": 'off' if (states('input_number.hvac_radiator_setpoint_family_room_60m_ago') | float(0)) == 0 else states('input_number.hvac_radiator_setpoint_family_room_60m_ago'),
              "radiator_setpoint_change": 1 if (states('sensor.hvac_radiator_setpoint_family_room') | float(0)) != (states('input_number.hvac_radiator_setpoint_family_room_60m_ago') | float(0)) else 0,
              "erik_office_temp_prev_hour": states('sensor.hvac_erik_office_temperature_60m_ago') | float(0),
              "kitchen_temp_prev_hour": states('sensor.hvac_kitchen_temperature_60m_ago') | float(0),
              "living_room_temp_prev_hour": states('sensor.hvac_living_room_temperature_60m_ago') | float(0),
              "basement_playroom_temp_prev_hour": states('sensor.hvac_basement_playroom_temperature_60m_ago') | float(0),
              "family_room_radiators_called_for_heat_within_hour": 1 if (states('input_boolean.radiator_called_for_heat_family_room_previous_hour') == 'on') else 0,
              "ducted_setpoint_prev_hour": 'off' if (states('input_number.hvac_ducted_setpoint_60m_ago') | float(0)) == 0 else states('input_number.hvac_ducted_setpoint_60m_ago'),
              "ducted_setpoint_change": 1 if (states('sensor.hvac_ducted_setpoint') | float(0)) != (states('input_number.hvac_ducted_setpoint_60m_ago') | float(0)) else 0,
              "offices_dining_room_kwh_hourly": states('input_number.heat_pump_offices_dining_room_energy_hourly') | float(0)
            } | tojson
          }}